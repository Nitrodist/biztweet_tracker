<!DOCTYPE html>
<html>
  <head>
    <title>Ruby on Rails: Welcome aboard</title>
    <style type="text/css" media="screen">

    </style>
    <link rel="stylesheet" type="text/css" media="all" href="/assets/application.css?body=1" />

    <script src="/assets/jquery.js?body=1" type="text/javascript"></script>
    <script src="/assets/twitterlib.js?body=1" type="text/javascript"></script>

    <script type="text/javascript">

    $(function(){

      var yearDays = [
                     [ 360, 365 ],
                     [ 353, 358 ],
                     [ 346, 351 ],
                     [ 339, 344 ],
                     [ 332, 337 ],
                     [ 325, 330 ],
                     [ 318, 323 ],
                     [ 311, 316 ],
                     [ 304, 309 ],
                     [ 297, 302 ],
                     [ 290, 295 ],
                     [ 283, 288 ],
                     [ 276, 281 ],
                     [ 269, 274 ],
                     [ 262, 267 ],
                     [ 255, 260 ],
                     [ 248, 253 ],
                     [ 241, 246 ]
                     ]; 
      function getDayOfYear(d) {   // d is a Date object
        var yn = d.getFullYear();
        var mn = d.getMonth();
        var dn = d.getDate();
        var d1 = new Date(yn,0,1,12,0,0); // noon on Jan. 1
        var d2 = new Date(yn,mn,dn,12,0,0); // noon on input date
        var ddiff = Math.round((d2-d1)/864e5);
        return ddiff+1; 
      }

      function inRange(dayOfYear) {
        
        for (var i = 0; i < yearDays.length; i++) {
          if (yearDays[i][0] <= dayOfYear && dayOfYear <= yearDays[i][1])
            return i;
        }
        return -1;
      }

      $("form").submit(function() {

        $("#weeks_of_tweets").empty();

        if ($("#search_q").val() == "")
          return false;

        var tweetWeeks = new Array(18);
        for (var i = 0; i < tweetWeeks.length; i++) {
          tweetWeeks[i] = new Array();
        }

        // Search for Nitrodist
        twitterlib.timeline($("#search_q").val(), { filter: '#CM2066' }, function (tweets, options) {
          $.each(tweets, function(i, tweet) {
            var day = getDayOfYear(new Date(Date.parse(tweet.created_at)));
            var position = inRange(day);
            if (position !== -1) {
              tweetWeeks[position].push(tweet);
            }
          });
          // with our other data structure
          $.each(tweetWeeks, function(i, tweetsForWeek) {
            $("#weeks_of_tweets").append("<li>" + 
                                         "<div class='toggle_parent'>" + 
                                         "<h3 class='indent float_left'>Week " + (18 - i) + "</h3>" + 
                                         "<p class='tweet_week_count'>Tweets: <strong>" + tweetsForWeek.length + "</strong></p>" + 
                                         "</div>" + 
                                         "<ul id=\"tweet_list_" + i + "\" class='tweet_list clear'></ul></li>");
            $.each(tweetsForWeek, function(j, ttweet) {
              $("#tweet_list_" + i).append(twitterlib.render(ttweet));
            });
          });
          $("#weeks_of_tweets > li .toggle_parent").css('cursor', 'pointer').click(function () {
            $(".tweet_list", $(this).parent()).toggle('slow');
          });
        });

        return false; // stop form from submitting.
      });

    });

    </script>
  
  </head>
  <body>
    <div id="page">

      <div id="sidebar">
        <ul id="sidebar-items">
          <li>
            <h3>About the Application</h3>
            <ul class="links">
              <li><a href="https://twitter.com/#!/search/%23CM2066">#CM2066 On Twitter</a></li>
              <li><a href="https://twitter.com/#!/MurrayMoman">@MurrayMoman</a></li>
              <li><a href="http://skullspace.ca">SkullSpace - A Hackerspace</a></li>
              <li><a href="http://rrc.mb.ca">Red River College</a></li>
              <li><a href="http://me.rrc.mb.ca/catalogue/CourseDescriptions.aspx?ProgCode=INFNF-DP&RegionCode=WPG#COMP-2126">Course Description</a></li>
            </ul>
          </li>
        </ul>
      </div>

      <div id="content">
        <h1>BizTweet Tracker</h1>

        <p style="border-bottom: 1px dashed #BBB; padding: 0 10px 20px; margin-bottom: 20px;">Hey there! This app queries twitter to see if you've got your tweets for the week in #CM2066. Type in your <strong>Twitter name</strong> and give it a try.</p>

        <form>
          <input type="text" id="search_q" /> <input class="same" type="submit" value="Get my tweets!" />
        </form>

        <ul id="weeks_of_tweets">
        </ul>
      </div>

      <div id="footer">&copy; Mark Campbell and Sean Mendoza 2011</div>
    </div>
  </body>
</html>
